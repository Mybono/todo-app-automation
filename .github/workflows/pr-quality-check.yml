name: ðŸ” Main Branch Checks

on:
  push:
    branches:
      - main

jobs:
  main-validation:
    name: âœ… Main Branch Validation
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ“ Run lint
        run: npm run lint

      - name: ðŸ§ª Run tests
        run: npm test

      - name: ðŸ” Check for dependency changes
        id: deps
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep 'package.json\|package-lock.json' || true)
          if [ -n "$CHANGED" ]; then
            echo "## ðŸ“¦ Dependency Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "Warning: package.json or package-lock.json changed. Make sure security audit, license check, and bundle size review are done." >> $GITHUB_STEP_SUMMARY
          else
            echo "No dependency changes detected."
          fi

      - name: ðŸ“Š Generate basic metrics
        run: |
          echo "## ðŸ“Š Push Metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Files changed: $(git diff --name-only HEAD~1 HEAD | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Commits: $(git rev-list --count HEAD~1..HEAD)" >> $GITHUB_STEP_SUMMARY
